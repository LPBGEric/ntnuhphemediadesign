import speech_recognition as sr
from google.cloud import speech_v1
import json
import re
from datetime import datetime, timedelta

class ExerciseAssessmentApp:
    def __init__(self):
        self.recognizer = sr.Recognizer()
        self.exercise_standards = {
            "å¼·åº¦é‹å‹•": {"weekly_minutes": 75, "sessions": 3},
            "ä¸­åº¦é‹å‹•": {"weekly_minutes": 150, "sessions": 5},
            "èµ°è·¯": {"daily_steps": 8000}
        }
    
    def record_voice(self, duration=30):
        """éŒ„è£½ç”¨æˆ¶èªéŸ³"""
        with sr.Microphone() as source:
            print("è«‹æè¿°æ‚¨çš„é‹å‹•ç¿’æ…£...")
            audio = self.recognizer.listen(source, timeout=duration)
        return audio
    
    def transcribe_audio(self, audio):
        """ä½¿ç”¨Google Cloud Speech-to-Textè½‰æ›èªéŸ³"""
        try:
            text = self.recognizer.recognize_google(audio, language='zh-TW')
            return text
        except Exception as e:
            print(f"èªéŸ³è­˜åˆ¥éŒ¯èª¤: {str(e)}")
            return None
    
    def analyze_exercise_pattern(self, text):
        """åˆ†æé‹å‹•æè¿°æ–‡æœ¬"""
        results = {
            "å¼·åº¦é‹å‹•": {"minutes": 0, "sessions": 0},
            "ä¸­åº¦é‹å‹•": {"minutes": 0, "sessions": 0},
            "èµ°è·¯": {"steps": 0}
        }
        
        # è§£æé‹å‹•æ™‚é–“å’Œé »ç‡
        patterns = {
            "å¼·åº¦é‹å‹•": r"(?:è·‘æ­¥|æ¸¸æ³³|ç±ƒçƒ|ç¶²çƒ).*?(\d+).*?åˆ†é˜.*?(\d+).*?æ¬¡",
            "ä¸­åº¦é‹å‹•": r"(?:å¿«èµ°|é¨è»Š|ç‘œä¼½).*?(\d+).*?åˆ†é˜.*?(\d+).*?æ¬¡",
            "èµ°è·¯": r"(?:èµ°è·¯|æ­¥è¡Œ).*?(\d+).*?æ­¥"
        }
        
        for exercise_type, pattern in patterns.items():
            matches = re.finditer(pattern, text)
            for match in matches:
                if exercise_type != "èµ°è·¯":
                    minutes, sessions = map(int, match.groups())
                    results[exercise_type]["minutes"] += minutes
                    results[exercise_type]["sessions"] += sessions
                else:
                    steps = int(match.group(1))
                    results[exercise_type]["steps"] += steps
        
        return results
    
    def evaluate_exercise(self, exercise_data):
        """è©•ä¼°é‹å‹•æ˜¯å¦é”æ¨™"""
        evaluation = {
            "é”æ¨™é …ç›®": [],
            "æœªé”æ¨™é …ç›®": [],
            "å»ºè­°": []
        }
        
        # è©•ä¼°å„é¡é‹å‹•
        for exercise_type, data in exercise_data.items():
            if exercise_type in ["å¼·åº¦é‹å‹•", "ä¸­åº¦é‹å‹•"]:
                weekly_minutes = data["minutes"] * data["sessions"]
                required_minutes = self.exercise_standards[exercise_type]["weekly_minutes"]
                required_sessions = self.exercise_standards[exercise_type]["sessions"]
                
                if weekly_minutes >= required_minutes and data["sessions"] >= required_sessions:
                    evaluation["é”æ¨™é …ç›®"].append(f"{exercise_type}ï¼ˆæ¯é€±{weekly_minutes}åˆ†é˜ï¼Œ{data['sessions']}æ¬¡ï¼‰")
                else:
                    evaluation["æœªé”æ¨™é …ç›®"].append(f"{exercise_type}ï¼ˆç›®å‰ï¼šæ¯é€±{weekly_minutes}åˆ†é˜ï¼Œ{data['sessions']}æ¬¡ï¼‰")
                    evaluation["å»ºè­°"].append(
                        f"å»ºè­°å¢åŠ {exercise_type}æ™‚é–“è‡³æ¯é€±{required_minutes}åˆ†é˜ï¼Œåˆ†{required_sessions}æ¬¡é€²è¡Œ"
                    )
            
            elif exercise_type == "èµ°è·¯":
                daily_steps = data["steps"]
                required_steps = self.exercise_standards[exercise_type]["daily_steps"]
                
                if daily_steps >= required_steps:
                    evaluation["é”æ¨™é …ç›®"].append(f"æ¯æ—¥æ­¥æ•¸ï¼ˆ{daily_steps}æ­¥ï¼‰")
                else:
                    evaluation["æœªé”æ¨™é …ç›®"].append(f"æ¯æ—¥æ­¥æ•¸ï¼ˆç›®å‰ï¼š{daily_steps}æ­¥ï¼‰")
                    evaluation["å»ºè­°"].append(f"å»ºè­°å¢åŠ æ¯æ—¥æ­¥è¡Œé‡è‡³{required_steps}æ­¥")
        
        return evaluation
    
    def generate_report(self, evaluation):
        """ç”Ÿæˆè©•ä¼°å ±å‘Š"""
        report = "é‹å‹•ç¿’æ…£è©•ä¼°å ±å‘Š\n"
        report += "=" * 30 + "\n\n"
        
        if evaluation["é”æ¨™é …ç›®"]:
            report += "âœ… å·²é”æ¨™é …ç›®ï¼š\n"
            for item in evaluation["é”æ¨™é …ç›®"]:
                report += f"- {item}\n"
            report += "\n"
        
        if evaluation["æœªé”æ¨™é …ç›®"]:
            report += "âŒ æœªé”æ¨™é …ç›®ï¼š\n"
            for item in evaluation["æœªé”æ¨™é …ç›®"]:
                report += f"- {item}\n"
            report += "\n"
        
        if evaluation["å»ºè­°"]:
            report += "ğŸ“ æ”¹å–„å»ºè­°ï¼š\n"
            for suggestion in evaluation["å»ºè­°"]:
                report += f"- {suggestion}\n"
        
        return report
    
    def run(self):
        """é‹è¡Œæ‡‰ç”¨ç¨‹åº"""
        # 1. éŒ„è£½èªéŸ³
        audio = self.record_voice()
        
        # 2. è½‰æ›èªéŸ³ç‚ºæ–‡å­—
        text = self.transcribe_audio(audio)
        if not text:
            return "ç„¡æ³•è­˜åˆ¥èªéŸ³ï¼Œè«‹é‡è©¦"
        
        # 3. åˆ†æé‹å‹•æ¨¡å¼
        exercise_data = self.analyze_exercise_pattern(text)
        
        # 4. è©•ä¼°é‹å‹•æƒ…æ³
        evaluation = self.evaluate_exercise(exercise_data)
        
        # 5. ç”Ÿæˆå ±å‘Š
        report = self.generate_report(evaluation)
        
        return report
